<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meu primeiro jogo Multiplayer</title>
    <style>
      #screen {
        border: 10px solid #ccc;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
        image-rendering: -moz-crisp-edges;
        width: 500px;
        height: 500px;
      }

      .container {
        width: 400px;
      }

      .btn-container {
        display: flex;
        width: 100%;
        margin: auto;
        align-items: center;
        flex-direction: column;
      }

      .btn-container button {
        width: 150px;
        height: 50px;
        margin: 3px;
        border-radius: 100%;
        color: rgb(255, 255, 255);
        font-weight: bold;
        background: rgb(223, 15, 15);
        font-size: 18px;
      }

      .left {
        align-self: flex-start;
        background: rgb(15, 70, 223) !important;
      }
      .right {
        align-self: flex-end;
        margin-top: -50px !important;
      }

      #down {
        background: rgb(15, 70, 223) !important;
      }

      @media (max-width: 500px) {
        #screen {
          width: 90vw;
          height: 40vh;
        }
        .btn-container button {
          width: 110px;
        }

        .container {
          width: 90vw;
          margin: 8px;
        }
      }
    </style>
    <div class="container">
      <h1>Placar:</h1>
      <div id="placar"></div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <div class="container">
      <canvas id="screen" width="10" height="10"></canvas>
      <audio src="moeda.mp3"></audio>
      <div class="btn-container">
        <button id="up">Up</button>
        <button id="left" class="left">Left</button>
        <button id="right" class="right">Right</button>
        <button id="down">Down</button>
      </div>
    </div>
  </body>
  <script type="module">
    import { createKeyboardListener } from "./keyboardListener.js";
    import { createGame } from "./create-game.js";
    import { renderScreen } from "./render-screen.js";

    const game = createGame();
    const keyboardListener = createKeyboardListener(document);

    const collectFruitAudio = new Audio("collect.mp3");
    const collect100FruitAudio = new Audio("life.mp3");

    const socket = io();
    let id = 0;
    socket.on("connect", () => {
      const playerId = socket.id;
      id = socket.id;
      console.log(`Player connected on Cliente with id: ${playerId}`);
      const screen = document.getElementById("screen");
      renderScreen(screen, game, requestAnimationFrame, playerId);
      Notification.requestPermission();
    });

    socket.on("setup", (state) => {
      const playerId = socket.id;
      game.setState(state);
      keyboardListener.registerPlayerId(playerId);
      keyboardListener.subscribe(game.movePlayer);
      keyboardListener.subscribe((command) => {
        socket.emit("move-player", command);
      });
    });

    socket.on("add-player", (command) => {
      // console.log({ command });
      game.addPlayer(command);
    });

    socket.on("remove-player", (command) => {
      // console.log({ command });
      game.removePlayer(command);
      keyboardListener.unSubscribe(game.movePlayer);
    });

    socket.on("move-player", (command) => {
      const playerId = socket.id;

      if (playerId !== command.playerId) {
        game.movePlayer(command);
      }
    });

    socket.on("add-fruit", (command) => {
      game.addFruit(command);
    });
    socket.on("remove-fruit", (command) => {
      game.removeFruit(command);
      // console.log(game);
      setPlacar();
      if (game.state.collect > 10) {
        collect100FruitAudio.pause();
        collect100FruitAudio.currentTime = 0;
        collect100FruitAudio.play();
        game.state.collect = 0;
      } else {
        collectFruitAudio.pause();
        collectFruitAudio.currentTime = 0;
        collectFruitAudio.play();
      }
    });
    document.getElementById("up").onclick = function () {
      moveButtonUp();
    };
    document.getElementById("left").onclick = function () {
      moveButtonLeft();
    };
    document.getElementById("down").onclick = function () {
      moveButtonDown();
    };
    document.getElementById("right").onclick = function () {
      moveButtonRigh();
    };

    const move = (command) => {
      game.movePlayer(command);
      socket.emit("move-player", command);
    };

    function moveButtonUp() {
      const command = {
        playerId: id,
        keyPress: "ArrowUp",
      };
      move(command);
    }

    function moveButtonLeft() {
      move({
        playerId: id,
        keyPress: "ArrowLeft",
      });
    }

    function moveButtonRigh() {
      move({
        playerId: id,
        keyPress: "ArrowRight",
      });
    }
    function moveButtonDown() {
      move({
        playerId: id,
        keyPress: "ArrowDown",
      });
    }

    const placar = document.getElementById("placar");

    function setPlacar() {
      const teste = game.state.collectFrutisPlayers
        .sort((a, b) => b.frutis - a.frutis)
        .map((item) => {
          return `<p style="
      padding: 10px;
      margin: 0;">
    Nome: ${item.name} frutas: ${item.frutis}</p>`;
        })
        .filter((item, index) => Boolean(index < 3));

      placar.innerHTML = teste.join("");
    }
  </script>
</html>
